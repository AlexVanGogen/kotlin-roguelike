# Архитектурное описание Roguelike

## Общие сведения о системе

Игра представляет собой случайно сгенерированную карту подземелья с монстрами и предметами. Карта представляет собой таблицу из символов, каждый символ обозначает либо тип местности (земля/стена), либо предмет, либо существо (игрока или монстра) Игрок `@` способен перемещаться по карте, сражаться с монстрами и собирать предметы. Игрок существует в пределах карты и не может из нее выбраться. Цель игрока -- собрать все специальные предметы.

У игрока есть инвентарь ограниченной вместимости, где он может хранить собранные предметы.

Монстры могут атаковать игрока, а игрок, в свою очередь, может атаковать монстров. Игра продолжается до тех пор, пока игрок либо не соберет все нужные предметы, либо не умрет от атак монстров.

В подземелье также присутствуют стены, через которые нельзя пройти без наличия определенного предмета в инвентаре.

## Описание типичного пользователя

Тигран -- миллениал, детерминист и филантроп. Хоть он и родился в год выхода фильма "Темный рыцарь", он знает, что такое лурк, bash.org и bash. Также знает, как пропатчить KDE2 под FreeBSD. В школе ему труднее всего дается информатика, так как там заставляют работать в Ворде. И тем не менее, только в 9 лет он узнал, что такое roguelike, и решил, что будет играть в консольные рогалики до тех пор, пока не выйдет что-то поинтереснее (например, консольный Overwatch). Сейчас Тигран собирается поиграть в данный roguelike.

Тигран входит в игру и видит стартовый экран, с которого он может перейти на карту по нажатию кнопки `Enter`. По карте он перемещается при помощи стрелок. При встрече с монстром (монстр находится на соседней позиции) пользователь имеет возможность его атаковать, для этого он перемещается в ту сторону, где сейчас находится монстр.

Тигран видит на карте что-то необычное и подходит ближе. Это предмет, и он может его взять, встав на позицию предмета и нажав `g`. Если в инвентаре есть место, предмет исчезнет с карты и будет храниться только у игрока.

Теперь Тигран хочет посмотреть, а что он вообще насобирал за игру. Он нажимает на `e` и рядом с картой видит свой инвентарь. Каждому предмету соответствует своя буква. Тигран нажимает на клавишу с буквой, соответствующей некоторому предмету, и этот предмет выбрасывается с инвентаря в игровое пространство. Выйти обратно в игровое пространство можно по нажатию клавиши `Esc`.

Пролистывая список предметов в инвентаре, Тигран видит, что некоторые предметы, скорее всего, являются предметами экипировки и их можно надеть на персонажа. Экипировку можно посмотреть в отдельном окне, нажав в игре `w`. Тигран нажимает `w` и видит список экипировки. Он видит, что он собрал, и что из собранного сейчас надето на персонаже. Здесь также каждому предмету соответствует своя буква. После нажатия на клавишу с буквой, соответствующей предмету, этот предмет надевается на персонажа. Если у персонажа уже был надет предмет похожего назначения (например, броня), то предыдущая броня автоматически снимается. Выйти обратно в игровое пространство можно по нажатию клавиши `Esc`.

Также Тигран хочет контролировать статы своего персонажа. Он смотрит на специальные показатели (HP/Atk/Def), постоянно висящие рядом с игровым пространством. Это позволяет оценить, как скоро персонаж может умереть, а также какая экипировка лучше.

Рядом со статами отображается, какие особые предметы Тигран уже собрал. Так он может контролировать, насколько он далек от победы.

## Диаграмма компонент и классов

![alt text](https://github.com/AlexVanGogen/kotlin-roguelike/blob/master/docs/ComponentDiagram.png "Component diagram")

Вся система разбивается на четыре большие компоненты:

* World – вся информация о карте и том, что на ней должно быть изображено, а также средства для создания новой карты.

* Scenes – окна и экраны, которые видит пользователь. Внутри каждой сцены реализована логика отображения ее на экране пользователя.

* Creatures system – это сами существа (Real creatures) и механизмы их создания (Creatures engine).
  * Real creatures – игровые объекты с определенным поведением, обеспечивающим взаимодействие их с картой или друг с другом (например, могут перемещаться или атаковать). К ним же относится и игрок.
  * Creatures engine – средства для создания всех существ.

* Stuff system – это предметы (Real items) и механизмы их создания (Items engine).
  * Real items – игровые объекты, которые могут взаимодействовать только с игроком (игрок может их поднять/выбросить/экипировать и так далее).
  * Items engine – средства для создания всех предметов.
  
Более детальное описание – диаграмма классов:

![alt text](https://github.com/AlexVanGogen/kotlin-roguelike/blob/master/docs/NewClassDiagram.png "Class diagram")

## Диаграммы последовательностей и конечных автоматов

![alt text](https://github.com/AlexVanGogen/kotlin-roguelike/blob/master/docs/SequenceDiagram.png "Sequence diagram")

Изначально игрок оказывается на стартовом экране (StartScene). По нажатию клавиши `Enter` он попадает на основной игровой экран (PlayScene). Он может путешествовать по нему и совершать различные действия (собирать предметы, атаковать врагов).

По нажатию клавиши `i` открывается небольшое окно с инвентарем (InventoryScene) (при этом бОльшая часть игрового экрана остается видна, но взаимодействовать с ним нельзя). Сделав необходимые операции (выбросить предмет), игрок возвращается на игровой экран по нажатию клавиши `Esc`.

По нажатию клавиши `e` открывается небольшое окно с экипировкой (EquipmentScene) (при этом бОльшая часть игрового экрана остается видна, но взаимодействовать с ним нельзя). Сделав необходимые операции (надеть/снять предмет), игрок возвращается на игровой экран по нажатию клавиши `Esc`.

Если игрок собрал все специальные предметы, он автоматически перемещается на экран с победой (WinScene), откуда он может начать новую игру по нажатию клавиши `Enter`.

Если игрок потерял все свои очки здоровья, он автоматически перемещается на экран с поражением (LoseScene), откуда он может начать новую игру по нажатию клавиши `Enter`.

![alt text](https://github.com/AlexVanGogen/kotlin-roguelike/blob/master/docs/AutomataDiagram.png "Finite automata diagram")

Изначально игрок оказывается на стартовом экране (StartScene), откуда он может попасть только на основной игровой экран (PlayScene). Находясь на игровом экране, игрок может перейти на один из четырех других экранов, переход в два из которых он инициирует сам (окна инвентаря (InventoryScene) и экипировки (EquipmentScene)), а остальные два появляются в зависимости от произошедшего события (победа (WinScene)/поражение (LoseScene)).

Из окон инвентаря и экипировки можно только вернуться на игровой экран. Окна с победой/поражением аналогичны стартовому окну, из них можно начать новую игру (и перейти на новый игровой экран) или выйти из игры.
